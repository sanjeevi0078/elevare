<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elevare - Mission Control</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/assets/css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
</head>
<body class="overflow-x-hidden">
    <!-- Floating particles -->
    <div class="particle" style="left: 10%; animation-delay: 0s;"></div>
    <div class="particle" style="left: 20%; animation-delay: 2s;"></div>
    <div class="particle" style="left: 30%; animation-delay: 4s;"></div>
    <div class="particle" style="left: 40%; animation-delay: 6s;"></div>
    <div class="particle" style="left: 50%; animation-delay: 8s;"></div>
    <div class="particle" style="left: 60%; animation-delay: 10s;"></div>
    <div class="particle" style="left: 70%; animation-delay: 12s;"></div>
    <div class="particle" style="left: 80%; animation-delay: 14s;"></div>
    <div class="particle" style="left: 90%; animation-delay: 16s;"></div>
    
    <!-- Floating orbs -->
    <div class="floating-orb orb-1"></div>
    <div class="floating-orb orb-2"></div>
    <div class="floating-orb orb-3"></div>

    <header class="fixed w-full top-0 left-0 z-50 glass-morphism">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="/" class="text-3xl font-bold animated-gradient-text">Elevare</a>
            <div class="flex items-center space-x-4">
                <div class="hidden md:flex items-center gap-3 cursor-pointer" id="user-header" onclick="window.location.href='/profile'">
                    <div class="w-10 h-10 rounded-full bg-gradient-to-r from-purple-500 to-pink-500 flex items-center justify-center text-white font-bold" id="user-initials">--</div>
                    <div class="text-sm">
                        <div class="text-white font-semibold" id="user-name">Guest</div>
                        <div class="text-purple-300 text-xs" id="user-subtitle">Click to view profile</div>
                    </div>
                </div>
                <a href="/intake" class="cta-button inline-block text-white font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-plus mr-2"></i>New Idea
                </a>
                <button onclick="logout()" class="text-gray-400 hover:text-red-400 transition-colors" title="Logout">
                    <i class="fas fa-sign-out-alt text-xl"></i>
                </button>
            </div>
        </nav>
    </header>

    <main class="pt-24">
        <!-- Hero Dashboard Section -->
        <section class="py-20 px-4 hero-gradient-enhanced">
            <div class="container mx-auto">
                <!-- Welcome Header -->
                <div class="text-center mb-16">
                    <div class="inline-flex items-center gap-2 bg-gradient-to-r from-green-500/20 to-blue-500/20 border border-green-400/30 rounded-full px-4 py-2 mb-6 animate-float">
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        <span class="text-sm font-medium text-green-200">üéÜ Mission Control Active</span>
                    </div>
                    <h1 class="text-5xl md:text-6xl font-bold mb-6 animated-gradient-text-hero">
                        MISSION CONTROL
                    </h1>
                    <p class="text-xl text-gray-300 max-w-2xl mx-auto">Your startup empire awaits üöÄ</p>
                </div>

                <!-- Stats Overview (real data only) -->
                <div class="grid grid-cols-2 md:grid-cols-2 gap-6 mb-16">
                    <div class="stat-card glass-morphism-enhanced text-center">
                        <div class="text-4xl mb-2">üí°</div>
                        <div class="text-3xl font-bold animated-gradient-text-enhanced mb-2" id="stat-active-ideas">0</div>
                        <div class="text-gray-300 font-semibold">Active Ideas</div>
                    </div>
                    <div class="stat-card glass-morphism-enhanced text-center">
                        <div class="text-4xl mb-2">ü§ù</div>
                        <div class="text-3xl font-bold animated-gradient-text-enhanced mb-2" id="stat-matches">0</div>
                        <div class="text-gray-300 font-semibold">Cofounder Matches</div>
                    </div>
                </div>

                <!-- Main Dashboard Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Ideas Section -->
                    <div class="lg:col-span-2">
                        <div class="glass-morphism-enhanced rounded-3xl p-8">
                            <div class="flex items-center justify-between mb-8">
                                <h3 class="text-3xl font-bold animated-gradient-text-enhanced">
                                    üí° Your Ideas
                                </h3>
                                <a href="/intake" class="cta-button-enhanced cta-button-primary">
                                    <i class="fas fa-plus mr-2"></i>Add New
                                </a>
                            </div>
                            
                            <div class="space-y-6" id="ideasSection">
                                <!-- No static items. Only dynamic ideas will be inserted below -->

                                <!-- Dynamic Ideas will be inserted here -->
                                <div id="ideasDynamic" class="space-y-6"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Sidebar -->
                    <div class="space-y-8">
                        <!-- Quick Actions -->
                        <div class="glass-morphism-enhanced rounded-3xl p-8">
                            <h3 class="text-2xl font-bold mb-6 animated-gradient-text-enhanced">
                                ‚ö° Quick Launch
                            </h3>
                            <div class="space-y-4">
                                <a href="/cofounder" class="block p-4 rounded-xl bg-purple-500/10 border border-purple-500/20 hover:bg-purple-500/20 transition-all group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="text-2xl">ü§ù</div>
                                            <div>
                                                <div class="font-semibold group-hover:text-purple-300 transition-colors">Find Cofounders</div>
                                                <div class="text-xs text-gray-400">Match with real founders</div>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                    </div>
                                </a>
                                
                                <a href="/roadmap" class="block p-4 rounded-xl bg-blue-500/10 border border-blue-500/20 hover:bg-blue-500/20 transition-all group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="text-2xl">üó∫Ô∏è</div>
                                            <div>
                                                <div class="font-semibold group-hover:text-blue-300 transition-colors">View Roadmaps</div>
                                                <div class="text-xs text-gray-400">Explore curated roadmaps</div>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                    </div>
                                </a>
                                
                                <a href="/mentorship" class="block p-4 rounded-xl bg-yellow-500/10 border border-yellow-500/20 hover:bg-yellow-500/20 transition-all group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="text-2xl">üéÜ</div>
                                            <div>
                                                <div class="font-semibold group-hover:text-yellow-300 transition-colors">Meet Mentors</div>
                                                <div class="text-xs text-gray-400">Connect with mentors</div>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                    </div>
                                </a>
                                
                                <a href="/events" class="block p-4 rounded-xl bg-green-500/10 border border-green-500/20 hover:bg-green-500/20 transition-all group">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="text-2xl">üéâ</div>
                                            <div>
                                                <div class="font-semibold group-hover:text-green-300 transition-colors">Join Events</div>
                                                <div class="text-xs text-gray-400">See upcoming events</div>
                                            </div>
                                        </div>
                                        <i class="fas fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
                                    </div>
                                </a>
                            </div>
                        </div>

                        <!-- Achievement Section -->
                        <div class="glass-morphism-enhanced rounded-3xl p-8">
                            <h3 class="text-2xl font-bold mb-6 animated-gradient-text-enhanced">
                                üèÜ Achievements
                            </h3>
                            <div class="space-y-4">
                                <div class="flex items-center gap-3 p-3 rounded-xl bg-green-500/10 border border-green-500/20">
                                    <div class="text-2xl">üöÄ</div>
                                    <div>
                                        <div class="font-semibold text-sm text-green-300">First Idea Published</div>
                                        <div class="text-xs text-gray-500">Unlock by creating your first idea</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 p-3 rounded-xl bg-purple-500/10 border border-purple-500/20">
                                    <div class="text-2xl">ü§ù</div>
                                    <div>
                                        <div class="font-semibold text-sm text-purple-300">Cofounder Connected</div>
                                        <div class="text-xs text-gray-500">Unlock by connecting with a match</div>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3 p-3 rounded-xl bg-gray-500/10 border border-gray-500/20 opacity-50">
                                    <div class="text-2xl">üí∞</div>
                                    <div>
                                        <div class="font-semibold text-sm text-gray-400">First Funding</div>
                                        <div class="text-xs text-gray-500">Complete roadmap to unlock</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script>
        // Gate: require a selected profile
        (function enforceProfileSelection(){
            const profileId = localStorage.getItem('elevare_profile_id');
            if (!profileId) {
                // Friendly redirect to profile setup
                const msg = document.createElement('div');
                msg.style.position = 'fixed';
                msg.style.top = '74px';
                msg.style.left = '50%';
                msg.style.transform = 'translateX(-50%)';
                msg.style.zIndex = '9999';
                msg.style.padding = '10px 14px';
                msg.style.border = '1px solid rgba(255,255,255,0.2)';
                msg.style.borderRadius = '10px';
                msg.style.background = 'rgba(17,24,39,0.8)';
                msg.style.color = '#c7d2fe';
                msg.textContent = 'Create a profile first ‚Äî redirecting...';
                document.body.appendChild(msg);
                setTimeout(()=> window.location.href = '/profile-setup', 900);
            }
        })();

        // Animate dashboard elements
        document.addEventListener('DOMContentLoaded', function() {
            // Animate stat cards
            gsap.fromTo('.stat-card', {
                y: 30,
                opacity: 0,
                scale: 0.9
            }, {
                y: 0,
                opacity: 1,
                scale: 1,
                duration: 0.6,
                stagger: 0.1,
                ease: 'back.out(1.7)'
            });
            
            // Animate feature cards
            gsap.fromTo('.feature-card-enhanced', {
                y: 50,
                opacity: 0
            }, {
                y: 0,
                opacity: 1,
                duration: 0.8,
                stagger: 0.2,
                delay: 0.3,
                ease: 'power3.out'
            });
            
            // Animate sidebar cards
            gsap.fromTo('.glass-morphism-enhanced', {
                x: 50,
                opacity: 0
            }, {
                x: 0,
                opacity: 1,
                duration: 0.8,
                stagger: 0.1,
                delay: 0.5,
                ease: 'power3.out'
            });

            // Load saved ideas from backend (real data)
            (async function loadIdeas(){
                try {
                    // Get user ID from JWT token
                    let userId = null;
                    const token = localStorage.getItem('access_token');
                    if (token) {
                        try {
                            const payload = JSON.parse(atob(token.split('.')[1]));
                            userId = payload.sub; // Extract user ID from JWT
                            console.log('üìù Loading ideas for user:', userId);
                        } catch (e) {
                            console.error('Failed to decode JWT:', e);
                        }
                    }
                    
                    // Fallback to stored profile ID
                    if (!userId) {
                        userId = localStorage.getItem('elevare_profile_id');
                    }
                    
                    const r = await fetch(`${window.location.origin}/ideas/${userId ? `?user_id=${userId}` : ''}`);
                    if(!r.ok) throw new Error('Failed to load ideas');
                    const ideas = await r.json();
                    const ideasCount = Array.isArray(ideas) ? ideas.length : 0;
                    const ideasStat = document.getElementById('stat-active-ideas');
                    if (ideasStat) ideasStat.textContent = String(ideasCount);

                    if (!Array.isArray(ideas) || ideas.length === 0) {
                        document.getElementById('ideasDynamic').innerHTML = `
                            <div class="text-center py-10 text-gray-400">
                                <div class="text-5xl mb-2">üìù</div>
                                <p>No ideas yet.</p>
                                <a href="/intake" class="cta-button mt-4 inline-block">Create your first idea</a>
                            </div>`;
                        return;
                    }

                    const c = document.getElementById('ideasDynamic');
                    c.innerHTML = ideas.map(item => {
                        const ri = item.refined_idea || {};
                        const mp = item.market_profile || {};
                        const score = typeof item.overall_confidence_score === 'number' ? item.overall_confidence_score.toFixed(1) : 'N/A';
                        const ideaText = item.problem_statement || ri.solution_concept || 'Idea';
                        return `
                        <div class="feature-card-enhanced group">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center gap-3 mb-3">
                                        <div class="text-3xl">üí°</div>
                                        <h4 class="text-xl font-bold text-white group-hover:text-purple-300 transition-colors">${ri.idea_title || 'Untitled Idea'}</h4>
                                        <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-500/20 text-green-300 border border-green-500/30">Score: ${score}</span>
                                    </div>
                                    <p class="text-gray-300 mb-4">${ri.solution_concept || ''}</p>
                                    <div class="flex items-center gap-4 text-sm">
                                        <span class="tag">${ri.core_domain ? 'üéØ ' + ri.core_domain : 'üéØ Idea'}</span>
                                        <span class="text-blue-400">üí∞ ${typeof mp.market_viability_score === 'number' ? mp.market_viability_score.toFixed(1) : 'N/A'} viability</span>
                                        ${typeof mp.raw_competitor_count === 'number' ? `<span class="text-gray-400">üè¢ ${mp.raw_competitor_count} competitors</span>` : ''}
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="window.findCofoundersForIdea('${ideaText.replace(/'/g, "\\'")}')" class="w-10 h-10 rounded-lg bg-blue-500/20 text-blue-300 border border-blue-500/30 hover:bg-blue-500/30 transition-all flex items-center justify-center" title="Find Cofounders">
                                        <i class="fas fa-users"></i>
                                    </button>
                                    <button onclick="viewFullIdea(${item.id})" class="w-10 h-10 rounded-lg bg-green-500/20 text-green-300 border border-green-500/30 hover:bg-green-500/30 transition-all flex items-center justify-center" title="View Full Details">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="/roadmap?idea_id=${item.id}" class="w-10 h-10 rounded-lg bg-purple-500/20 text-purple-300 border border-purple-500/30 hover:bg-purple-500/30 transition-all flex items-center justify-center" title="View Roadmap">
                                        <i class="fas fa-route"></i>
                                    </a>
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                } catch(e) {
                    // Non-blocking; keep static content
                }
            })();

            // Function to view full idea details in modal
            window.viewFullIdea = async function(ideaId) {
                try {
                    const response = await fetch(`/ideas/${ideaId}`);
                    if (!response.ok) throw new Error('Failed to load idea');
                    const idea = await response.json();
                    
                    const ri = idea.refined_idea || {};
                    const da = idea.dimensional_analysis || {};
                    const team = idea.recommended_team || {};
                    const funding = idea.funding_requirements || {};
                    
                    // Create modal
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 overflow-y-auto';
                    modal.innerHTML = `
                        <div class="glass-morphism-enhanced rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-8 relative">
                            <button onclick="this.closest('.fixed').remove()" class="absolute top-4 right-4 w-10 h-10 rounded-lg bg-red-500/20 text-red-300 hover:bg-red-500/30 transition-all">
                                <i class="fas fa-times"></i>
                            </button>
                            
                            <h2 class="text-3xl font-bold mb-6 bg-gradient-to-r from-purple-400 to-pink-400 bg-clip-text text-transparent">
                                ${ri.idea_title || 'Untitled Idea'}
                            </h2>
                            
                            <div class="space-y-6">
                                <div>
                                    <h3 class="text-xl font-bold text-purple-300 mb-2">üí° Problem Statement</h3>
                                    <p class="text-gray-300">${ri.problem_statement || 'N/A'}</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-xl font-bold text-purple-300 mb-2">üéØ Solution</h3>
                                    <p class="text-gray-300">${ri.solution || 'N/A'}</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-xl font-bold text-purple-300 mb-2">üé™ Target Market</h3>
                                    <p class="text-gray-300">${ri.target_market || 'N/A'}</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-xl font-bold text-purple-300 mb-2">üí∞ Revenue Model</h3>
                                    <p class="text-gray-300">${ri.revenue_model || 'N/A'}</p>
                                </div>
                                
                                <div>
                                    <h3 class="text-xl font-bold text-purple-300 mb-2">‚ö° Key Features</h3>
                                    <ul class="list-disc list-inside text-gray-300 space-y-1">
                                        ${(ri.key_features || []).map(f => `<li>${f}</li>`).join('')}
                                    </ul>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="glass-morphism rounded-xl p-4">
                                        <div class="text-sm text-gray-400 mb-1">Confidence Score</div>
                                        <div class="text-2xl font-bold text-green-400">${(da.overall_confidence || 0).toFixed(2)}</div>
                                    </div>
                                    <div class="glass-morphism rounded-xl p-4">
                                        <div class="text-sm text-gray-400 mb-1">Domain</div>
                                        <div class="text-2xl font-bold text-blue-400">${da.domain || 'N/A'}</div>
                                    </div>
                                </div>
                                
                                <div class="flex gap-3 pt-4">
                                    <a href="/roadmap?idea_id=${ideaId}" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg font-bold hover:from-purple-500 hover:to-pink-500 transition-all text-center">
                                        <i class="fas fa-route mr-2"></i>View Roadmap
                                    </a>
                                    <a href="/cofounder.html" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-lg font-bold hover:from-blue-500 hover:to-cyan-500 transition-all text-center">
                                        <i class="fas fa-users mr-2"></i>Find Cofounders
                                    </a>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                } catch (error) {
                    alert('Failed to load idea details');
                }
            };

            // Load current user profile for header and matches count
            (async function loadUserAndMatches(){
                const id = localStorage.getItem('elevare_profile_id');
                const nameFallback = localStorage.getItem('elevare_profile_name') || null;
                const nameEl = document.getElementById('user-name');
                const initialsEl = document.getElementById('user-initials');
                const subEl = document.getElementById('user-subtitle');
                const matchesEl = document.getElementById('stat-matches');
                try {
                    if (!id) {
                        if (nameEl) nameEl.textContent = 'Guest';
                        if (initialsEl) initialsEl.textContent = '--';
                        if (subEl) subEl.textContent = 'Select a profile on Cofounder page';
                        if (matchesEl) matchesEl.textContent = '0';
                        return;
                    }
                    const usersResp = await fetch(`${window.location.origin}/matching/users`);
                    const users = await usersResp.json();
                    const user = Array.isArray(users) ? users.find(u => String(u.id) === String(id)) : null;
                    const name = user?.name || nameFallback || 'Profile';
                    if (nameEl) nameEl.textContent = name;
                    if (initialsEl) initialsEl.textContent = (name.split(' ').map(s=>s[0]).join('').slice(0,2) || '--').toUpperCase();
                    if (subEl) subEl.textContent = user?.interest || '';
                    // matches count
                    const mResp = await fetch(`${window.location.origin}/matching/matches/${id}`);
                    const matches = await mResp.json();
                    if (matchesEl) matchesEl.textContent = String(Array.isArray(matches) ? matches.length : 0);
                } catch(e) {
                    // fallback to stored name
                    if (nameFallback && nameEl) nameEl.textContent = nameFallback;
                }
            })();
        });
    </script>

    <!-- Lightweight Developer Tools (non-intrusive) -->
    <div style="position: fixed; right: 16px; bottom: 16px; z-index: 9999;">
        <details style="background: rgba(0,0,0,0.6); border: 1px solid rgba(99,102,241,0.4); padding: 12px; border-radius: 12px; width: 340px;">
            <summary style="cursor: pointer; color: #c7d2fe; font-weight: 600;">Developer Tools</summary>
            <div style="margin-top: 10px; color: #e5e7eb; font-size: 14px;">
                <div style="margin-bottom: 8px; font-weight: 600;">Create Profile</div>
                <input id="dt-name" placeholder="Name" style="width:100%; margin-bottom:6px; padding:6px; border-radius:8px; background:#111827; border:1px solid #374151; color:#e5e7eb;" />
                <input id="dt-email" placeholder="Email" style="width:100%; margin-bottom:6px; padding:6px; border-radius:8px; background:#111827; border:1px solid #374151; color:#e5e7eb;" />
                <input id="dt-location" placeholder="Location (optional)" style="width:100%; margin-bottom:6px; padding:6px; border-radius:8px; background:#111827; border:1px solid #374151; color:#e5e7eb;" />
                <input id="dt-interest" placeholder="Interest (optional)" style="width:100%; margin-bottom:6px; padding:6px; border-radius:8px; background:#111827; border:1px solid #374151; color:#e5e7eb;" />
                <input id="dt-commitment" placeholder="Commitment (0-1, optional)" type="number" step="0.1" min="0" max="1" style="width:100%; margin-bottom:6px; padding:6px; border-radius:8px; background:#111827; border:1px solid #374151; color:#e5e7eb;" />
                <input id="dt-skills" placeholder="Skills (comma-separated)" style="width:100%; margin-bottom:8px; padding:6px; border-radius:8px; background:#111827; border:1px solid #374151; color:#e5e7eb;" />
                <button id="dt-create" style="width:100%; padding:8px; border-radius:8px; background:#4f46e5; color:white; font-weight:600;">Create Profile</button>
                <div id="dt-create-msg" style="margin-top:6px; font-size:12px; color:#a5b4fc;"></div>

                <hr style="border-color:#374151; margin:10px 0;" />

                <div style="display:flex; gap:8px; align-items:center;">
                    <button id="dt-load-users" style="flex:1; padding:8px; border-radius:8px; background:#10b981; color:white; font-weight:600;">Load Users</button>
                    <input id="dt-match-id" placeholder="User ID" style="width:110px; padding:6px; border-radius:8px; background:#111827; border:1px solid #374151; color:#e5e7eb;" />
                    <button id="dt-find-matches" style="padding:8px; border-radius:8px; background:#2563eb; color:white; font-weight:600;">Matches</button>
                </div>
                <div id="dt-results" style="margin-top:8px; max-height:180px; overflow:auto; font-size:12px; background:#0b1220; border:1px solid #1f2937; border-radius:8px; padding:8px;"></div>
            </div>
        </details>
    </div>

    <!-- Load required JavaScript modules -->
    <script src="/static/js/api-client.js"></script>
    <script src="/static/js/dashboard.js"></script>

    <script>
        // Global function to find cofounders for an idea (called from inline idea cards)
        window.findCofoundersForIdea = function(ideaText) {
            if (!ideaText || ideaText.length < 20) {
                alert('Idea description is too short to find matches. Please add more details.');
                return;
            }
            
            // Store idea in session for the cofounder page to use
            sessionStorage.setItem('matchingIdea', ideaText);
            sessionStorage.setItem('matchingIdeaTitle', ideaText.substring(0, 50) + '...');
            
            // Redirect to cofounder page with autoMatch flag
            window.location.href = '/cofounder?autoMatch=true';
        };
    </script>

    <script>
        // Minimal wiring for matching API
        (function(){
            const base = window.location.origin;
            const el = (id) => document.getElementById(id);
            const msg = (t) => el('dt-results').innerHTML = t;

            el('dt-create')?.addEventListener('click', async () => {
                const skills = (el('dt-skills').value || '').split(',').map(s => s.trim()).filter(Boolean);
                const body = {
                    name: (el('dt-name').value || '').trim(),
                    email: (el('dt-email').value || '').trim(),
                    location: el('dt-location').value || null,
                    interest: el('dt-interest').value || null,
                    personality: null,
                    commitment_level: el('dt-commitment').value ? parseFloat(el('dt-commitment').value) : null,
                    skills: skills.length ? skills : null
                };
                if (!body.name || !body.email) {
                    el('dt-create-msg').textContent = 'Name and email are required';
                    return;
                }
                el('dt-create').disabled = true;
                el('dt-create').textContent = 'Creating...';
                el('dt-create-msg').textContent = '';
                try {
                    const r = await fetch(`${base}/matching/users`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
                    if(!r.ok){ const e = await r.json().catch(()=>({})); throw new Error(e.detail || 'Failed to create'); }
                    const data = await r.json();
                    // Persist profile context for cross-page header
                    try {
                        localStorage.setItem('elevare_profile_id', String(data.id));
                        if (data.name) localStorage.setItem('elevare_profile_name', data.name);
                    } catch(_) {}
                    el('dt-create-msg').textContent = `Created user ID: ${data.id}`;
                    // Update header immediately
                    const nameEl = document.getElementById('user-name');
                    const initialsEl = document.getElementById('user-initials');
                    const subEl = document.getElementById('user-subtitle');
                    if (nameEl) nameEl.textContent = data.name || 'Profile';
                    if (initialsEl) initialsEl.textContent = (data.name || '  ').split(' ').map(s=>s[0]).join('').slice(0,2).toUpperCase();
                    if (subEl) subEl.textContent = data.interest || data.location || '';
                } catch(e){
                    el('dt-create-msg').textContent = `Error: ${e.message}`;
                } finally {
                    el('dt-create').disabled = false;
                    el('dt-create').textContent = 'Create Profile';
                }
            });

            el('dt-load-users')?.addEventListener('click', async () => {
                msg('Loading users...');
                try {
                    const r = await fetch(`${base}/matching/users`);
                    if(!r.ok) throw new Error('Failed to load users');
                    const users = await r.json();
                    msg(`<pre>${JSON.stringify(users, null, 2)}</pre>`);
                } catch(e){ msg(`Error: ${e.message}`); }
            });

            el('dt-find-matches')?.addEventListener('click', async () => {
                const id = (el('dt-match-id').value || '').trim();
                if(!id){ msg('Enter a user ID'); return; }
                msg('Finding matches...');
                try {
                    const r = await fetch(`${base}/matching/matches/${id}`);
                    if(!r.ok){ const e = await r.json().catch(()=>({})); throw new Error(e.detail || 'Failed'); }
                    const matches = await r.json();
                    msg(`<pre>${JSON.stringify(matches, null, 2)}</pre>`);
                } catch(e){ msg(`Error: ${e.message}`); }
            });
        })();

        // Auto-load user profile
        async function loadCurrentUser() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                // No token, use guest mode but allow access
                return;
            }

            try {
                // Decode JWT to get user ID
                const payload = JSON.parse(atob(token.split('.')[1]));
                const userId = payload.sub;

                // Fetch user data
                const response = await fetch(`/matching/users/${userId}`);
                if (response.ok) {
                    const user = await response.json();
                    // Update header
                    const initials = user.name.split(' ').map(n => n[0]).join('').toUpperCase();
                    document.getElementById('user-initials').textContent = initials;
                    document.getElementById('user-name').textContent = user.name;
                }
            } catch (error) {
                console.error('Error loading user:', error);
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('access_token');
                localStorage.removeItem('token_type');
                sessionStorage.clear();
                window.location.href = '/login';
            }
        }

        // Load user on page load
        document.addEventListener('DOMContentLoaded', loadCurrentUser);
    </script>
    </body>
    </html>